== Deployment steps

There are two ways to deploy this stack

=== 1. Automatic Deployment
You can automatically deploy the stack directly from the CLI using taskcat. This method requires updating the `.taskcat.yml` file with your specific requirements, particularly the `SociIndexVersion` parameter:

.Example .taskcat.yml configuration for automatic deployment
[source,yaml]
----
project:
  name: cfn-ecr-aws-soci-index-builder
  owner: quickstart@amazon.com
  s3_regional_buckets: true
  lambda_source_path: functions/source
  lambda_zip_path: functions/packages
  parameters:
    QSS3BucketName: $[taskcat_autobucket]
    QSS3KeyPrefix: "cfn-ecr-aws-soci-index-builder/"
tests:
  can-deploy:
    stack_name: "Soci-index-builder"
    # stack_name_prefix: "PrefixStackname"
    # stack_name_suffix: "SufficStackName"
    parameters:
      SociRepositoryImageTagFilters: "*:*"
      SociIndexVersion: "V2"
    regions:
      - us-east-1
    template: templates/SociIndexBuilder.yml
----

To deploy the stack, run:
[source,bash]
----
taskcat test run -n
----

The `-n` flag prevents the stack from being deleted after deployment, which is the default behavior of `test run`.

[TIP]
====
You can customize the stack name using one of these options:

* `stack_name`: Set a specific name
* `stack_name_prefix`: Add a prefix to the name
* `stack_name_suffix`: Add a suffix to the name
====

[IMPORTANT]
====
While this automatic deployment provides a convenient one-command deployment, it has some limitations:

* The `SociIndexVersion` is set at deployment time and cannot be changed without redeploying the stack
* The automatic deployment method sets a fixed SociIndexVersion in the taskcat configuration, using the upload command and console deployment approach allows you to specify different SociIndexVersion values each time you create a new stack from the pre-uploaded template
====


=== 2. Manual Deployment

[TIP]
====
If you used the automatic deployment then you can skip these steps and directly go check the cloudformation stack has deployed
====

After configuring the taskcat.yml file, run `taskcat upload` from the root directory of the repository.

The upload command will:

* Read the configuration from `.taskcat.yml` file
* Package the lambda functions using the provided Dockerfile (this is why Docker is required)
* Create S3 buckets in all specified regions with the naming pattern `tcat-<hash>-<region>`
* Upload the CloudFormation template and Lambda packages to these buckets with the prefix `cfn-ecr-aws-soci-index-builder/`
* Make the CloudFormation template available at the URL pattern `https://<bucket-name>.s3.<region>.amazonaws.com/cfn-ecr-aws-soci-index-builder/templates/SociIndexBuilder.yml`

[TIP]
====
Before proceeding with the actual deployment, you can run `taskcat upload --dry-run` to safely preview the resources that will be provisioned. This command simulates the upload process without making any actual changes, helping you verify your configuration.

image::../docs/deployment_guide/images/taskcat_dry_run.png[Taskcat dry-run example]
====

[NOTE]
====
In the above example you're deploying to the us-east-2 region, the S3 bucket name created is:
`tcat-318317e4bf395d3fa89e1d675d64f43e-us-east-2`
====

After the upload completes:

1. Verify your deployment - Find your S3 bucket (starts with `tcat-`) in the AWS Console
+
image::../docs/deployment_guide/images/verify_S3.png[Verify S3 bucket contents]

2. Locate the template at `cfn-ecr-aws-soci-index-builder/templates/SociIndexBuilder.yml`

3. Copy the Object URL:
+
image::../docs/deployment_guide/images/object_url.png[Object URL location]

[TIP]
====
You can also construct the template URL using this pattern:
`https://<bucket-name>.s3.<region>.amazonaws.com/cfn-ecr-aws-soci-index-builder/templates/SociIndexBuilder.yml`

Replace `<bucket-name>` with your S3 bucket name (starting with `tcat-`) and `<region>` with your deployment region.
====


1. Sign in to your AWS account, and open AWS Cloudformation console.

2. Choose the AWS Region you want to deploy and choose *Create stack* option, select *With new resources(standard)*
* Paste the S3 Url from the predeployment step
+
[IMPORTANT]
====
Ensure that you select the same region that was specified in your .taskcat.yml file.
====
+
image::../docs/deployment_guide/images/create_stack.png[Create stack example]

3. On the *Specify stack details* page, provide a stack name.
 Review the parameters for the template. Provide values for the parameters that require input, particularly the S3 bucket name (starting with `tcat-`) created during the taskcat upload step. 
+
image::../docs/deployment_guide/images/stack_details.png[Stack details example]

The CloudFormation template includes the following parameters:

* *SociIndexVersion*: Determines the type of indices generated when a new image is pushed to the ECR repository.
** V2 (Recommended) - Latest version with enhanced security features
** V1 - Legacy version for backward compatibility

* *SociRepositoryImageTagFilters:* Comma-separated list of SOCI repository image tag filters. Each filter is a repository name followed by a colon, ":" and followed by a tag. Both repository names and tags may contain wildcards denoted by an asterisk, "\*". 
For example, `prod/*:latest` matches all images tagged with "latest" that are pushed to any repositories that start with "prod", while `"dev:*"` matches all images pushed to the "dev" repository. Use `"\*:*"` to match all images pushed to all repositories in your private registry.

* *QSS3BucketName*: Name of the S3 bucket for your copy of the deployment assets. Keep the default name unless you are customizing the template.

* *QSS3KeyPrefix*: S3 key prefix that is used to simulate a folder for your copy of the deployment assets. Keep the default prefix unless you are customizing the template.

* *IamPermissionsBoundaryArn*: IAM Roles might require an IAM Permissions boundary in order to be created and perform subsequent API calls to services. This parameter expects the ARN of an IAM policy, or to be set to none. When you finish reviewing and customizing the parameters, choose Next.

+
NOTE: Unless you're customizing the CFN template or are instructed otherwise in this guide's *Predeployment* section, don't change the default settings for the following parameters: `QSS3BucketName`, `QSS3BucketRegion`, and `QSS3KeyPrefix`. Changing the values of these parameters will modify code references that point to the Amazon Simple Storage Service (Amazon S3) bucket name and key prefix.
+

* On the *Configure stack options* page, you can https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/aws-properties-resource-tags.html[specify tags] (key-value pairs) for resources in your stack and https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-console-create-stack.html#configure-stack-options[set advanced options]. When you finish, choose *Next*.

* On the *Review* page, review and confirm the template settings. Under *Capabilities*, select all of the check boxes to acknowledge that the template creates AWS Identity and Access Management (IAM) resources that might require the ability to automatically expand macros.

* Choose *Create stack*. The stack takes about 5 minutes to deploy.

* Monitor the stack's status, and when the status is *CREATE_COMPLETE*, the CFN AWS SOCI Index Builder deployment is ready.

* To view the created resources, choose the *Resources* tab.
